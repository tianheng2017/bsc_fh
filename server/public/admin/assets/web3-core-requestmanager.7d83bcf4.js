import{d as y}from"./rollup-plugin-node-polyfills.dd1027b1.js";import{l as b}from"./web3-core-helpers.1fd5b4bd.js";import{l as m}from"./web3-providers-ws.d5947685.js";import{l as w}from"./web3-providers-http.7c889e06.js";import{l as P}from"./web3-providers-ipc.2e091ead.js";var a={messageId:0};a.toPayload=function(r,i){if(!r)throw new Error('JSONRPC method should be specified for params: "'+JSON.stringify(i)+'"!');return a.messageId++,{jsonrpc:"2.0",id:a.messageId,method:r,params:i||[]}};a.isValidResponse=function(r){return Array.isArray(r)?r.every(i):i(r);function i(e){return!!e&&!e.error&&e.jsonrpc==="2.0"&&(typeof e.id=="number"||typeof e.id=="string")&&e.result!==void 0}};a.toBatchPayload=function(r){return r.map(function(i){return a.toPayload(i.method,i.params)})};var l=a,g=l,v=b.errors,d=function(r){this.requestManager=r,this.requests=[]};d.prototype.add=function(r){this.requests.push(r)};d.prototype.execute=function(){var r=this.requests,i=this._sortResponses.bind(this);this.requestManager.sendBatch(r,function(e,t){t=i(t),r.map(function(n,o){return t[o]||{}}).forEach(function(n,o){if(r[o].callback){if(n&&n.error)return r[o].callback(v.ErrorResponse(n));if(!g.isValidResponse(n))return r[o].callback(v.InvalidResponse(n));try{r[o].callback(null,r[o].format?r[o].format(n.result):n.result)}catch(p){r[o].callback(p)}}})})};d.prototype._sortResponses=function(r){return(r||[]).sort((i,e)=>i.id-e.id)};var E=d,f=null,s=typeof globalThis=="object"?globalThis:void 0;if(!s)try{s=Function("return this")()}catch(r){s=self}typeof s.ethereum!="undefined"?f=s.ethereum:typeof s.web3!="undefined"&&s.web3.currentProvider&&(s.web3.currentProvider.sendAsync&&(s.web3.currentProvider.send=s.web3.currentProvider.sendAsync,delete s.web3.currentProvider.sendAsync),!s.web3.currentProvider.on&&s.web3.currentProvider.connection&&s.web3.currentProvider.connection.constructor.name==="ipcProviderWrapper"&&(s.web3.currentProvider.on=function(r,i){if(typeof i!="function")throw new Error("The second parameter callback must be a function.");switch(r){case"data":this.connection.on("data",function(e){var t="";e=e.toString();try{t=JSON.parse(e)}catch(n){return i(new Error("Couldn't parse response data"+e))}!t.id&&t.method.indexOf("_subscription")!==-1&&i(null,t)});break;default:this.connection.on(r,i);break}}),f=s.web3.currentProvider);var R=f;const{callbackify:q}=y;var u=b.errors,h=l,C=E,$=R,c=function r(i,e){this.provider=null,this.providers=r.providers,this.setProvider(i,e),this.subscriptions=new Map};c.givenProvider=$;c.providers={WebsocketProvider:m,HttpProvider:w,IpcProvider:P};c.prototype.setProvider=function(r,i){var e=this;if(r&&typeof r=="string"&&this.providers){if(/^http(s)?:\/\//i.test(r))r=new this.providers.HttpProvider(r);else if(/^ws(s)?:\/\//i.test(r))r=new this.providers.WebsocketProvider(r);else if(r&&typeof i=="object"&&typeof i.connect=="function")r=new this.providers.IpcProvider(r,i);else if(r)throw new Error(`Can't autodetect provider for "`+r+'"')}if(this.provider&&this.provider.connected&&this.clearSubscriptions(),this.provider=r||null,this.provider&&this.provider.on){typeof r.request=="function"?this.provider.on("message",function(n){if(n&&n.type==="eth_subscription"&&n.data){const o=n.data;o.subscription&&e.subscriptions.has(o.subscription)&&e.subscriptions.get(o.subscription).callback(null,o.result)}}):this.provider.on("data",function(o,p){o=o||p,o.method&&o.params&&o.params.subscription&&e.subscriptions.has(o.params.subscription)&&e.subscriptions.get(o.params.subscription).callback(null,o.params.result)}),this.provider.on("connect",function(){e.subscriptions.forEach(function(o){o.subscription.resubscribe()})}),this.provider.on("error",function(n){e.subscriptions.forEach(function(o){o.callback(n)})});const t=function(o){(!e._isCleanCloseEvent(o)||e._isIpcCloseError(o))&&(e.subscriptions.forEach(function(p){p.callback(u.ConnectionCloseError(o)),e.subscriptions.delete(p.subscription.id)}),e.provider&&e.provider.emit&&e.provider.emit("error",u.ConnectionCloseError(o))),e.provider&&e.provider.emit&&e.provider.emit("end",o)};this.provider.on("disconnect",t)}};c.prototype.send=function(r,i){if(i=i||function(){},!this.provider)return i(u.InvalidProvider());const{method:e,params:t}=r,n=h.toPayload(e,t),o=this._jsonrpcResultCallback(i,n);if(this.provider.request)q(this.provider.request.bind(this.provider))({method:e,params:t},i);else if(this.provider.sendAsync)this.provider.sendAsync(n,o);else if(this.provider.send)this.provider.send(n,o);else throw new Error("Provider does not have a request or send method to use.")};c.prototype.sendBatch=function(r,i){if(!this.provider)return i(u.InvalidProvider());var e=h.toBatchPayload(r);this.provider[this.provider.sendAsync?"sendAsync":"send"](e,function(t,n){if(t)return i(t);if(!Array.isArray(n))return i(u.InvalidResponse(n));i(null,n)})};c.prototype.addSubscription=function(r,i){if(this.provider.on)this.subscriptions.set(r.id,{callback:i,subscription:r});else throw new Error("The provider doesn't support subscriptions: "+this.provider.constructor.name)};c.prototype.removeSubscription=function(r,i){if(this.subscriptions.has(r)){var e=this.subscriptions.get(r).subscription.options.type;this.subscriptions.delete(r),this.send({method:e+"_unsubscribe",params:[r]},i);return}typeof i=="function"&&i(null)};c.prototype.clearSubscriptions=function(r){try{var i=this;return this.subscriptions.size>0&&this.subscriptions.forEach(function(e,t){(!r||e.name!=="syncing")&&i.removeSubscription(t)}),this.provider.reset&&this.provider.reset(),!0}catch(e){throw new Error(`Error while clearing subscriptions: ${e}`)}};c.prototype._isCleanCloseEvent=function(r){return typeof r=="object"&&([1e3].includes(r.code)||r.wasClean===!0)};c.prototype._isIpcCloseError=function(r){return typeof r=="boolean"&&r};c.prototype._jsonrpcResultCallback=function(r,i){return function(e,t){if(t&&t.id&&i.id!==t.id)return r(new Error(`Wrong response id ${t.id} (expected: ${i.id}) in ${JSON.stringify(i)}`));if(e)return r(e);if(t&&t.error)return r(u.ErrorResponse(t));if(!h.isValidResponse(t))return r(u.InvalidResponse(t));r(null,t.result)}};var B={Manager:c,BatchManager:C};export{B as l};
