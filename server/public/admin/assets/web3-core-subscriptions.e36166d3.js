import{l}from"./web3-core-helpers.1fd5b4bd.js";import{e as d}from"./eventemitter3.3dc09485.js";var y=l.errors,m=d.exports,v=l.formatters;function h(t){return t}function o(t){m.call(this),this.id=null,this.callback=h,this.arguments=null,this.lastBlock=null,this.options={subscription:t.subscription,type:t.type,requestManager:t.requestManager}}o.prototype=Object.create(m.prototype);o.prototype.constructor=o;o.prototype._extractCallback=function(t){if(typeof t[t.length-1]=="function")return t.pop()};o.prototype._validateArgs=function(t){var i=this.options.subscription;if(i||(i={}),i.params||(i.params=0),t.length!==i.params)throw y.InvalidNumberOfParams(t.length,i.params,i.subscriptionName)};o.prototype._formatInput=function(t){var i=this.options.subscription;if(!i||!i.inputFormatter)return t;var r=i.inputFormatter.map(function(p,s){return p?p(t[s]):t[s]});return r};o.prototype._formatOutput=function(t){var i=this.options.subscription;return i&&i.outputFormatter&&t?i.outputFormatter(t):t};o.prototype._toPayload=function(t){var i=[];if(this.callback=this._extractCallback(t)||h,this.subscriptionMethod||(this.subscriptionMethod=t.shift(),this.options.subscription.subscriptionName&&(this.subscriptionMethod=this.options.subscription.subscriptionName)),this.arguments||(this.arguments=this._formatInput(t),this._validateArgs(this.arguments),t=[]),i.push(this.subscriptionMethod),i=i.concat(this.arguments),t.length)throw new Error("Only a callback is allowed as parameter on an already instantiated subscription.");return{method:this.options.type+"_subscribe",params:i}};o.prototype.unsubscribe=function(t){this.options.requestManager.removeSubscription(this.id,t),this.id=null,this.lastBlock=null,this.removeAllListeners()};o.prototype.subscribe=function(){var t=this,i=Array.prototype.slice.call(arguments),r=this._toPayload(i);if(!r)return this;if(!this.options.requestManager.provider)return setTimeout(function(){var s=new Error("No provider set.");t.callback(s,null,t),t.emit("error",s)},0),this;if(!this.options.requestManager.provider.on)return setTimeout(function(){var s=new Error("The current provider doesn't support subscriptions: "+t.options.requestManager.provider.constructor.name);t.callback(s,null,t),t.emit("error",s)},0),this;if(this.lastBlock&&!!this.options.params&&typeof this.options.params=="object"&&(r.params[1]=this.options.params,r.params[1].fromBlock=v.inputBlockNumberFormatter(this.lastBlock+1)),this.id&&this.unsubscribe(),this.options.params=r.params[1],r.params[0]==="logs"&&!!r.params[1]&&typeof r.params[1]=="object"&&r.params[1].hasOwnProperty("fromBlock")&&isFinite(r.params[1].fromBlock)){var p=Object.assign({},r.params[1]);this.options.requestManager.send({method:"eth_getLogs",params:[p]},function(s,a){s?setTimeout(function(){t.callback(s,null,t),t.emit("error",s)},0):a.forEach(function(u){var e=t._formatOutput(u);t.callback(null,e,t),t.emit("data",e)})})}return typeof r.params[1]=="object"&&delete r.params[1].fromBlock,this.options.requestManager.send(r,function(s,a){!s&&a?(t.id=a,t.method=r.params[0],t.options.requestManager.addSubscription(t,function(u,e){u?(t.callback(u,!1,t),t.emit("error",u)):(Array.isArray(e)||(e=[e]),e.forEach(function(f){var n=t._formatOutput(f);if(t.lastBlock=!!n&&typeof n=="object"?n.blockNumber:null,typeof t.options.subscription.subscriptionHandler=="function")return t.options.subscription.subscriptionHandler.call(t,n);t.emit("data",n),t.callback(null,n,t)}))}),t.emit("connected",a)):setTimeout(function(){t.callback(s,!1,t),t.emit("error",s)},0)}),this};o.prototype.resubscribe=function(){this.options.requestManager.removeSubscription(this.id),this.id=null,this.subscribe(this.callback)};var g=o,b=g,c=function(i){this.name=i.name,this.type=i.type,this.subscriptions=i.subscriptions||{},this.requestManager=null};c.prototype.setRequestManager=function(t){this.requestManager=t};c.prototype.attachToObject=function(t){var i=this.buildCall(),r=this.name.split(".");r.length>1?(t[r[0]]=t[r[0]]||{},t[r[0]][r[1]]=i):t[r[0]]=i};c.prototype.buildCall=function(){var t=this;return function(){t.subscriptions[arguments[0]]||console.warn("Subscription "+JSON.stringify(arguments[0])+" doesn't exist. Subscribing anyway.");var i=new b({subscription:t.subscriptions[arguments[0]]||{},requestManager:t.requestManager,type:t.type});return i.subscribe.apply(i,arguments)}};var q={subscriptions:c,subscription:b};export{q as l};
