var S=Object.defineProperty,L=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var j=(t,e,r)=>e in t?S(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,x=(t,e)=>{for(var r in e||(e={}))K.call(e,r)&&j(t,r,e[r]);if(G)for(var r of G(e))W.call(e,r)&&j(t,r,e[r]);return t},A=(t,e)=>L(t,$(e));var H=(t,e,r)=>new Promise((i,u)=>{var o=p=>{try{f(r.next(p))}catch(b){u(b)}},s=p=>{try{f(r.throw(p))}catch(b){u(b)}},f=p=>p.done?i(p.value):Promise.resolve(p.value).then(o,s);f((r=r.apply(t,e)).next())});import{l as M}from"./web3-core-helpers.1fd5b4bd.js";import{l as J}from"./web3-utils.4b7ab516.js";import{l as U}from"./web3-core-promievent.cb88fa51.js";import{l as D}from"./web3-core-subscriptions.e36166d3.js";import{a as z}from"./@ethersproject.5d8623a7.js";var E=M.errors,P=M.formatters,g=J,O=U,Q=D.subscriptions,V=z,c=function(e){if(!e.call||!e.name)throw new Error('When creating a method you need to provide at least the "name" and "call" property.');this.name=e.name,this.call=e.call,this.params=e.params||0,this.inputFormatter=e.inputFormatter,this.outputFormatter=e.outputFormatter,this.transformPayload=e.transformPayload,this.extraFormatters=e.extraFormatters,this.abiCoder=e.abiCoder,this.requestManager=e.requestManager,this.accounts=e.accounts,this.defaultBlock=e.defaultBlock||"latest",this.defaultAccount=e.defaultAccount||null,this.transactionBlockTimeout=e.transactionBlockTimeout||50,this.transactionConfirmationBlocks=e.transactionConfirmationBlocks||24,this.transactionPollingTimeout=e.transactionPollingTimeout||750,this.transactionPollingInterval=e.transactionPollingInterval||1e3,this.blockHeaderTimeout=e.blockHeaderTimeout||10,this.defaultCommon=e.defaultCommon,this.defaultChain=e.defaultChain,this.defaultHardfork=e.defaultHardfork,this.handleRevert=e.handleRevert};c.prototype.setRequestManager=function(t,e){this.requestManager=t,e&&(this.accounts=e)};c.prototype.createFunction=function(t,e){var r=this.buildCall();return Object.defineProperty(r,"call",{configurable:!0,writable:!0,value:this.call}),this.setRequestManager(t||this.requestManager,e||this.accounts),r};c.prototype.attachToObject=function(t){var e=this.buildCall();Object.defineProperty(e,"call",{configurable:!0,writable:!0,value:this.call});var r=this.name.split(".");r.length>1?(t[r[0]]=t[r[0]]||{},t[r[0]][r[1]]=e):t[r[0]]=e};c.prototype.getCall=function(t){return typeof this.call=="function"?this.call(t):this.call};c.prototype.extractCallback=function(t){if(typeof t[t.length-1]=="function")return t.pop()};c.prototype.validateArgs=function(t){if(t.length!==this.params)throw E.InvalidNumberOfParams(t.length,this.params,this.name)};c.prototype.formatInput=function(t){var e=this;return this.inputFormatter?this.inputFormatter.map(function(r,i){return r?r.call(e,t[i]):t[i]}):t};c.prototype.formatOutput=function(t){var e=this;return Array.isArray(t)?t.map(function(r){return e.outputFormatter&&r?e.outputFormatter(r):r}):this.outputFormatter&&t?this.outputFormatter(t):t};c.prototype.toPayload=function(t){var e=this.getCall(t),r=this.extractCallback(t),i=this.formatInput(t);this.validateArgs(i);var u={method:e,params:i,callback:r};return this.transformPayload&&(u=this.transformPayload(u)),u};c.prototype._confirmTransaction=function(t,e,r){var i=this,u=!1,o=!0,s=0,f=0,p=null,b=null,n=null,l=!!r.params[0]&&typeof r.params[0]=="object"&&r.params[0].gas?r.params[0].gas:null,h=!!r.params[0]&&typeof r.params[0]=="object"&&r.params[0].data&&r.params[0].from&&!r.params[0].to,m=h&&r.params[0].data.length>2,C=[new c({name:"getBlockByNumber",call:"eth_getBlockByNumber",params:2,inputFormatter:[P.inputBlockNumberFormatter,function(v){return!!v}],outputFormatter:P.outputBlockFormatter}),new c({name:"getTransactionReceipt",call:"eth_getTransactionReceipt",params:1,inputFormatter:[null],outputFormatter:P.outputTransactionReceiptFormatter}),new c({name:"getCode",call:"eth_getCode",params:2,inputFormatter:[P.inputAddressFormatter,P.inputDefaultBlockNumberFormatter]}),new c({name:"getTransactionByHash",call:"eth_getTransactionByHash",params:1,inputFormatter:[null],outputFormatter:P.outputTransactionFormatter}),new Q({name:"subscribe",type:"eth",subscriptions:{newBlockHeaders:{subscriptionName:"newHeads",params:0,outputFormatter:P.outputBlockFormatter}}})],y={};C.forEach(v=>{v.attachToObject(y),v.requestManager=i.requestManager});var N=function(v,k,_,q,F){if(_)F.unsubscribe(),u=!0,g._fireError({message:"Failed to subscribe to new newBlockHeaders to confirm the transaction receipts.",data:_},t.eventEmitter,t.reject);else return F||(F={unsubscribe:function(){clearInterval(p),clearTimeout(b)}}),(v?O.resolve(v):y.getTransactionReceipt(e)).catch(function(a){F.unsubscribe(),u=!0,g._fireError({message:"Failed to check for transaction receipt:",data:a},t.eventEmitter,t.reject)}).then(function(a){return H(this,null,function*(){if(!a||!a.blockHash)throw new Error("Receipt missing or blockHash null");if(i.extraFormatters&&i.extraFormatters.receiptFormatter&&(a=i.extraFormatters.receiptFormatter(a)),t.eventEmitter.listeners("confirmation").length>0){var d;if(v===void 0||f!==0){var T=yield y.getBlockByNumber("latest"),R=T?T.hash:null;k?n?(d=yield y.getBlockByNumber(n.number+1),d&&(n=d,t.eventEmitter.emit("confirmation",f,a,R))):(d=yield y.getBlockByNumber(a.blockNumber),n=d,t.eventEmitter.emit("confirmation",f,a,R)):t.eventEmitter.emit("confirmation",f,a,R)}(k&&d||!k)&&f++,o=!1,f===i.transactionConfirmationBlocks+1&&(F.unsubscribe(),t.eventEmitter.removeAllListeners())}return a})}).then(function(a){return H(this,null,function*(){if(h&&!u){if(!a.contractAddress){o&&(F.unsubscribe(),u=!0),g._fireError(E.NoContractAddressFoundError(a),t.eventEmitter,t.reject,null,a);return}var d;try{d=yield y.getCode(a.contractAddress)}catch(R){}if(!d)return;var T=a.status===!0&&m;T||d.length>2?(t.eventEmitter.emit("receipt",a),i.extraFormatters&&i.extraFormatters.contractDeployFormatter?t.resolve(i.extraFormatters.contractDeployFormatter(a)):t.resolve(a),o&&t.eventEmitter.removeAllListeners()):g._fireError(E.ContractCodeNotStoredError(a),t.eventEmitter,t.reject,null,a),o&&F.unsubscribe(),u=!0}return a})}).then(function(a){return H(this,null,function*(){if(!h&&!u){if(!a.outOfGas&&(!l||l!==a.gasUsed)&&(a.status===!0||a.status==="0x1"||typeof a.status=="undefined"))t.eventEmitter.emit("receipt",a),t.resolve(a),o&&t.eventEmitter.removeAllListeners();else if(JSON.stringify(a,null,2),a.status===!1||a.status==="0x0")try{var d=null;if(i.handleRevert&&(i.call==="eth_sendTransaction"||i.call==="eth_sendRawTransaction")){var T=r.params[0];if(i.call==="eth_sendRawTransaction"){var R=r.params[0],w=V.parse(R);T=P.inputTransactionFormatter({data:w.data,to:w.to,from:w.from,gas:w.gasLimit.toHexString(),gasPrice:w.gasPrice?w.gasPrice.toHexString():void 0,value:w.value.toHexString()})}if(d=yield i.getRevertReason(T,a.blockNumber),d)g._fireError(E.TransactionRevertInstructionError(d.reason,d.signature,a),t.eventEmitter,t.reject,null,a);else throw!1}else throw!1}catch(Y){g._fireError(E.TransactionRevertedWithoutReasonError(a),t.eventEmitter,t.reject,null,a)}else g._fireError(E.TransactionOutOfGasError(a),t.eventEmitter,t.reject,null,a);o&&F.unsubscribe(),u=!0}})}).catch(function(){s++,k?s-1>=i.transactionPollingTimeout&&(F.unsubscribe(),u=!0,g._fireError(E.TransactionError("Transaction was not mined within "+i.transactionPollingTimeout+" seconds, please make sure your transaction was properly sent. Be aware that it might still be mined!"),t.eventEmitter,t.reject)):s-1>=i.transactionBlockTimeout&&(F.unsubscribe(),u=!0,g._fireError(E.TransactionError("Transaction was not mined within "+i.transactionBlockTimeout+" blocks, please make sure your transaction was properly sent. Be aware that it might still be mined!"),t.eventEmitter,t.reject))})},B=function(v){let k=!1;const _=()=>{p=setInterval(N.bind(null,v,!0),i.transactionPollingInterval)};if(!this.requestManager.provider.on)return _();y.subscribe("newBlockHeaders",function(q,F,a){if(k=!0,q||!F)return _();N(v,!1,q,F,a)}),b=setTimeout(()=>{k||_()},this.blockHeaderTimeout*1e3)}.bind(this);y.getTransactionReceipt(e).then(function(v){v&&v.blockHash?(t.eventEmitter.listeners("confirmation").length>0&&B(v),N(v,!1)):u||B()}).catch(function(){u||B()})};var I=function(t,e){var r=null;return typeof t=="number"?r=e.wallet[t]:!!t&&typeof t=="object"&&t.address&&t.privateKey?r=t:r=e.wallet[t.toLowerCase()],r};c.prototype.buildCall=function(){var t=this,e=t.call==="eth_sendTransaction"||t.call==="eth_sendRawTransaction",r=t.call==="eth_call",i=function(){let u=Array.prototype.slice.call(arguments);var o=O(!e),s=t.toPayload(u);t.hexFormat=!1,t.call==="eth_getTransactionReceipt"&&(t.hexFormat=s.params.length<u.length&&u[u.length-1]==="hex");var f=function(n,l){if(t.handleRevert&&r&&t.abiCoder){var h;if(!n&&t.isRevertReasonString(l)?h=l.substring(10):n&&n.data&&(h=n.data.substring(10)),h){var m=t.abiCoder.decodeParameter("string","0x"+h),C="Error(String)";g._fireError(E.RevertInstructionError(m,C),o.eventEmitter,o.reject,s.callback,{reason:m,signature:C});return}}try{l=t.formatOutput(l)}catch(y){n=y}if(l instanceof Error&&(n=l),!n)s.callback&&s.callback(null,l);else return n.error&&(n=n.error),g._fireError(n,o.eventEmitter,o.reject,s.callback);e?(o.eventEmitter.emit("transactionHash",l),t._confirmTransaction(o,l,s)):n||o.resolve(l)},p=function(n){var l=A(x({},s),{method:"eth_sendRawTransaction",params:[n.rawTransaction]});t.requestManager.send(l,f)},b=function(n,l){if(l&&l.accounts&&l.accounts.wallet&&l.accounts.wallet.length){var h;if(n.method==="eth_sendTransaction"){var m=n.params[0];if(h=I(!!m&&typeof m=="object"?m.from:null,l.accounts),h&&h.privateKey){var m=JSON.parse(JSON.stringify(m));delete m.from,l.defaultChain&&!m.chain&&(m.chain=l.defaultChain),l.defaultHardfork&&!m.hardfork&&(m.hardfork=l.defaultHardfork),l.defaultCommon&&!m.common&&(m.common=l.defaultCommon),l.accounts.signTransaction(m,h.privateKey).then(p).catch(function(B){if(typeof o.eventEmitter.listeners=="function"&&o.eventEmitter.listeners("error").length){try{o.eventEmitter.emit("error",B)}catch(v){}o.eventEmitter.removeAllListeners(),o.eventEmitter.catch(function(){})}o.reject(B)});return}}else if(n.method==="eth_sign"){var C=n.params[1];if(h=I(n.params[0],l.accounts),h&&h.privateKey){var y=l.accounts.sign(C,h.privateKey);n.callback&&n.callback(null,y.signature),o.resolve(y.signature);return}}}return l.requestManager.send(n,f)};return e&&!!s.params[0]&&typeof s.params[0]=="object"&&typeof s.params[0].gasPrice=="undefined"&&(typeof s.params[0].maxPriorityFeePerGas=="undefined"||typeof s.params[0].maxFeePerGas=="undefined")?X(t,s.params[0]).then(n=>{n.gasPrice!==void 0?s.params[0].gasPrice=n.gasPrice:n.maxPriorityFeePerGas!==void 0&&n.maxFeePerGas!==void 0&&(s.params[0].maxPriorityFeePerGas=n.maxPriorityFeePerGas,s.params[0].maxFeePerGas=n.maxFeePerGas),e&&setTimeout(()=>{o.eventEmitter.emit("sending",s)},0),b(s,t)}):(e&&setTimeout(()=>{o.eventEmitter.emit("sending",s)},0),b(s,t)),e&&setTimeout(()=>{o.eventEmitter.emit("sent",s)},0),o.eventEmitter};return i.method=t,i.request=this.request.bind(this),i};function X(t,e){return new Promise((r,i)=>{try{var u=new c({name:"getBlockByNumber",call:"eth_getBlockByNumber",params:2,inputFormatter:[function(s){return s?g.toHex(s):"latest"},function(){return!1}]}).createFunction(t.requestManager),o=new c({name:"getGasPrice",call:"eth_gasPrice",params:0}).createFunction(t.requestManager);Promise.all([u(),o()]).then(s=>{const[f,p]=s;if((e.type==="0x2"||e.type===void 0)&&f&&f.baseFeePerGas){let b,n;e.gasPrice?(b=e.gasPrice,n=e.gasPrice,delete e.gasPrice):(b=e.maxPriorityFeePerGas||"0x9502F900",n=e.maxFeePerGas||g.toHex(g.toBN(f.baseFeePerGas).mul(g.toBN(2)).add(g.toBN(b)))),r({maxFeePerGas:n,maxPriorityFeePerGas:b})}else{if(e.maxPriorityFeePerGas||e.maxFeePerGas)throw Error("Network doesn't support eip-1559");r({gasPrice:p})}})}catch(s){i(s)}})}c.prototype.getRevertReason=function(t,e){var r=this;return new Promise(function(i,u){new c({name:"call",call:"eth_call",params:2,abiCoder:r.abiCoder,handleRevert:!0}).createFunction(r.requestManager)(t,g.numberToHex(e)).then(function(){i(!1)}).catch(function(o){o.reason?i({reason:o.reason,signature:o.signature}):u(o)})})};c.prototype.isRevertReasonString=function(t){return typeof t=="string"&&(t.length-2)/2%32===4&&t.substring(0,10)==="0x08c379a0"};c.prototype.request=function(){var t=this.toPayload(Array.prototype.slice.call(arguments));return t.format=this.formatOutput.bind(this),t};var it=c;export{it as l};
