var M=Object.defineProperty,$=Object.defineProperties;var D=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable;var F=(r,e,t)=>e in r?M(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,_=(r,e)=>{for(var t in e||(e={}))K.call(e,t)&&F(r,t,e[t]);if(b)for(var t of b(e))R.call(e,t)&&F(r,t,e[t]);return r},T=(r,e)=>$(r,D(e));import{c as q,r as U,d as N}from"./@ethereumjs.af3f5dff.js";import{l as W}from"./web3-core.2b55c245.js";import{l as J}from"./web3-core-method.621da27b.js";import{a as z}from"./eth-lib.fbef08b0.js";import{r as Q}from"./crypto-browserify.57e10b11.js";import{r as V}from"./@ethersproject.5d8623a7.js";import{s as X}from"./scrypt-js.661e7910.js";import{u as Y}from"./uuid.12ff4d55.js";import{l as Z}from"./web3-utils.4b7ab516.js";import{l as ee}from"./web3-core-helpers.1fd5b4bd.js";import{d as re}from"./ethereumjs-util.dbf079cb.js";var te=W,P=J,g=z,v=typeof q=="undefined"?Q():V,A=X.exports,oe=Y,h=Z,ne=ee,{TransactionFactory:L}=U(),G=N.default,k=N.Hardfork,x=re,d=function(r){return typeof r=="undefined"||r===null},I=function(r){return typeof r!="undefined"&&r!==null},p=function(){var e=this;te.packageInit(this,arguments),delete this.BatchRequest,delete this.extend;var t=[new P({name:"getNetworkId",call:"net_version",params:0,outputFormatter:parseInt}),new P({name:"getChainId",call:"eth_chainId",params:0,outputFormatter:h.hexToNumber}),new P({name:"getGasPrice",call:"eth_gasPrice",params:0}),new P({name:"getTransactionCount",call:"eth_getTransactionCount",params:2,inputFormatter:[function(o){if(h.isAddress(o))return o;throw new Error("Address "+o+' is not a valid address to get the "transactionCount".')},function(){return"latest"}]}),new P({name:"getBlockByNumber",call:"eth_getBlockByNumber",params:2,inputFormatter:[function(o){return o?h.toHex(o):"latest"},function(){return!1}]})];this._ethereumCall={},t.forEach(o=>{o.attachToObject(e._ethereumCall),o.setRequestManager(e._requestManager)}),this.wallet=new u(this)};p.prototype._addAccountFunctions=function(r){var e=this;return r.signTransaction=function(o,a){return e.signTransaction(o,r.privateKey,a)},r.sign=function(o){return e.sign(o,r.privateKey)},r.encrypt=function(o,a){return e.encrypt(r.privateKey,o,a)},r};p.prototype.create=function(e){return this._addAccountFunctions(g.create(e||h.randomHex(32)))};p.prototype.privateKeyToAccount=function(e,t){if(e.startsWith("0x")||(e="0x"+e),!t&&e.length!==66)throw new Error("Private key must be 32 bytes long");return this._addAccountFunctions(g.fromPrivate(e))};p.prototype.signTransaction=function(e,t,o){var a=this,n=!1,c={},f=!!(e&&(e.chain&&e.hardfork||e.common));if(o=o||function(){},!e)return n=new Error("No transaction object given!"),o(n),Promise.reject(n);if(I(e.common)&&d(e.common.customChain))return n=new Error("If tx.common is provided it must have tx.common.customChain"),o(n),Promise.reject(n);if(I(e.common)&&d(e.common.customChain.chainId))return n=new Error("If tx.common is provided it must have tx.common.customChain and tx.common.customChain.chainId"),o(n),Promise.reject(n);if(I(e.common)&&I(e.common.customChain.chainId)&&I(e.chainId)&&e.chainId!==e.common.customChain.chainId)return n=new Error("Chain Id doesnt match in tx.chainId tx.common.customChain.chainId"),o(n),Promise.reject(n);function s(m){const l=ae(m);if(l)return o(l),Promise.reject(l);try{var i=ne.formatters.inputCallFormatter(Object.assign({},m));i.data=i.data||"0x",i.value=i.value||"0x",i.gasLimit=i.gasLimit||i.gas,i.type==="0x1"&&i.accessList===void 0&&(i.accessList=[]),f?(i.common&&(c.common=G.forCustomChain(i.common.baseChain||"mainnet",{name:i.common.customChain.name||"custom-network",networkId:i.common.customChain.networkId,chainId:i.common.customChain.chainId},i.common.hardfork||k.London),delete i.common),i.chain&&(c.chain=i.chain,delete i.chain),i.hardfork&&(c.hardfork=i.hardfork,delete i.hardfork)):(c.common=G.forCustomChain("mainnet",{name:"custom-network",networkId:i.networkId,chainId:i.chainId},i.hardfork||k.London),delete i.networkId),t.startsWith("0x")&&(t=t.substring(2));var C=L.fromTxData(i,c),y=C.sign(Buffer.from(t,"hex")),B=y.validate(!0);if(B.length>0){let w="Signer Error: ";for(const O of B)w+=`${w} ${O}.`;throw new Error(w)}var j=y.serialize().toString("hex"),E="0x"+j,H=h.keccak256(E),S={messageHash:"0x"+Buffer.from(y.getMessageToSign(!0)).toString("hex"),v:"0x"+y.v.toString("hex"),r:"0x"+y.r.toString("hex"),s:"0x"+y.s.toString("hex"),rawTransaction:E,transactionHash:H};return o(null,S),S}catch(w){return o(w),Promise.reject(w)}}return e.type=ie(e),e.nonce!==void 0&&e.chainId!==void 0&&(e.gasPrice!==void 0||e.maxFeePerGas!==void 0&&e.maxPriorityFeePerGas!==void 0)&&f?Promise.resolve(s(e)):Promise.all([d(e.common)||d(e.common.customChain.chainId)?d(e.chainId)?a._ethereumCall.getChainId():e.chainId:void 0,d(e.nonce)?a._ethereumCall.getTransactionCount(a.privateKeyToAccount(t).address):e.nonce,d(f)?a._ethereumCall.getNetworkId():1,se(a,e)]).then(function(m){const[l,i,C,y]=m;if(d(l)&&d(e.common)&&d(e.common.customChain.chainId)||d(i)||d(C)||d(y))throw new Error(`One of the values "chainId", "networkId", "gasPrice", or "nonce" couldn't be fetched: `+JSON.stringify(m));return s(_(T(_(_({},e),d(e.common)||d(e.common.customChain.chainId)?{chainId:l}:{}),{nonce:i,networkId:C}),y))})};function ae(r){if(r.common&&r.chain&&r.hardfork)return new Error("Please provide the @ethereumjs/common object or the chain and hardfork property but not all together.");if(r.chain&&!r.hardfork||r.hardfork&&!r.chain)return new Error('When specifying chain and hardfork, both values must be defined. Received "chain": '+r.chain+', "hardfork": '+r.hardfork);if(!r.gas&&!r.gasLimit&&!r.maxPriorityFeePerGas&&!r.maxFeePerGas)return new Error('"gas" is missing');if(r.gas&&r.gasPrice){if(r.gas<0||r.gasPrice<0)return new Error("Gas or gasPrice is lower than 0")}else if(r.maxPriorityFeePerGas<0||r.maxFeePerGas<0)return new Error("maxPriorityFeePerGas or maxFeePerGas is lower than 0");if(r.nonce<0||r.chainId<0)return new Error("Nonce or chainId is lower than 0")}function ie(r){const e=r.maxFeePerGas!==void 0||r.maxPriorityFeePerGas!==void 0;let t;if(r.type!==void 0?t=h.toHex(r.type):r.type===void 0&&e&&(t="0x2"),r.gasPrice!==void 0&&(t==="0x2"||e))throw Error("eip-1559 transactions don't support gasPrice");if((t==="0x1"||t==="0x0")&&e)throw Error("pre-eip-1559 transaction don't support maxFeePerGas/maxPriorityFeePerGas");return e||r.common&&r.common.hardfork&&r.common.hardfork.toLowerCase()===k.London||r.hardfork&&r.hardfork.toLowerCase()===k.London?t="0x2":(r.accessList||r.common&&r.common.hardfork&&r.common.hardfork.toLowerCase()===k.Berlin||r.hardfork&&r.hardfork.toLowerCase()===k.Berlin)&&(t="0x1"),t}function se(r,e){return new Promise((t,o)=>{try{(e.type===void 0||e.type<"0x2")&&e.gasPrice!==void 0?t({gasPrice:e.gasPrice}):Promise.all([r._ethereumCall.getBlockByNumber(),r._ethereumCall.getGasPrice()]).then(a=>{const[n,c]=a;if(e.type==="0x2"&&n&&n.baseFeePerGas){let f,s;e.gasPrice?(f=e.gasPrice,s=e.gasPrice,delete e.gasPrice):(f=e.maxPriorityFeePerGas||"0x9502F900",s=e.maxFeePerGas||h.toHex(h.toBN(n.baseFeePerGas).mul(h.toBN(2)).add(h.toBN(f)))),t({maxFeePerGas:s,maxPriorityFeePerGas:f})}else{if(e.maxPriorityFeePerGas||e.maxFeePerGas)throw Error("Network doesn't support eip-1559");t({gasPrice:c})}}).catch(a=>{o(a)})}catch(a){o(a)}})}p.prototype.recoverTransaction=function(e,t={}){const o=Buffer.from(e.slice(2),"hex"),a=L.fromSerializedData(o);return h.toChecksumAddress(a.getSenderAddress().toString("hex"))};p.prototype.hashMessage=function(e){var t=h.isHexStrict(e)?e:h.utf8ToHex(e),o=h.hexToBytes(t),a=Buffer.from(o),n=`Ethereum Signed Message:
`+o.length,c=Buffer.from(n),f=Buffer.concat([c,a]);return x.bufferToHex(x.keccak256(f))};p.prototype.sign=function(e,t){if(t.startsWith("0x")||(t="0x"+t),t.length!==66)throw new Error("Private key must be 32 bytes long");var o=this.hashMessage(e),a=g.sign(o,t),n=g.decodeSignature(a);return{message:e,messageHash:o,v:n[0],r:n[1],s:n[2],signature:a}};p.prototype.recover=function(e,t,o){var a=[].slice.apply(arguments);return!!e&&typeof e=="object"?this.recover(e.messageHash,g.encodeSignature([e.v,e.r,e.s]),!0):(o||(e=this.hashMessage(e)),a.length>=4?(o=a.slice(-1)[0],o=typeof o=="boolean"?!!o:!1,this.recover(e,g.encodeSignature(a.slice(1,4)),o)):g.recover(e,t))};p.prototype.decrypt=function(r,e,t){if(typeof e!="string")throw new Error("No password given.");var o=!!r&&typeof r=="object"?r:JSON.parse(t?r.toLowerCase():r);if(o.version!==3)throw new Error("Not a valid V3 wallet");var a,n;if(o.crypto.kdf==="scrypt")n=o.crypto.kdfparams,a=A.syncScrypt(Buffer.from(e),Buffer.from(n.salt,"hex"),n.n,n.r,n.p,n.dklen);else if(o.crypto.kdf==="pbkdf2"){if(n=o.crypto.kdfparams,n.prf!=="hmac-sha256")throw new Error("Unsupported parameters to PBKDF2");a=v.pbkdf2Sync(Buffer.from(e),Buffer.from(n.salt,"hex"),n.c,n.dklen,"sha256")}else throw new Error("Unsupported key derivation scheme");var c=Buffer.from(o.crypto.ciphertext,"hex"),f=h.sha3(Buffer.from([...a.slice(16,32),...c])).replace("0x","");if(f!==o.crypto.mac)throw new Error("Key derivation failed - possibly wrong password");var s=v.createDecipheriv(o.crypto.cipher,a.slice(0,16),Buffer.from(o.crypto.cipherparams.iv,"hex")),m="0x"+Buffer.from([...s.update(c),...s.final()]).toString("hex");return this.privateKeyToAccount(m,!0)};p.prototype.encrypt=function(r,e,t){var o=this.privateKeyToAccount(r,!0);t=t||{};var a=t.salt||v.randomBytes(32),n=t.iv||v.randomBytes(16),c,f=t.kdf||"scrypt",s={dklen:t.dklen||32,salt:a.toString("hex")};if(f==="pbkdf2")s.c=t.c||262144,s.prf="hmac-sha256",c=v.pbkdf2Sync(Buffer.from(e),Buffer.from(s.salt,"hex"),s.c,s.dklen,"sha256");else if(f==="scrypt")s.n=t.n||8192,s.r=t.r||8,s.p=t.p||1,c=A.syncScrypt(Buffer.from(e),Buffer.from(s.salt,"hex"),s.n,s.r,s.p,s.dklen);else throw new Error("Unsupported kdf");var m=v.createCipheriv(t.cipher||"aes-128-ctr",c.slice(0,16),n);if(!m)throw new Error("Unsupported cipher");var l=Buffer.from([...m.update(Buffer.from(o.privateKey.replace("0x",""),"hex")),...m.final()]),i=h.sha3(Buffer.from([...c.slice(16,32),...l])).replace("0x","");return{version:3,id:oe.v4({random:t.uuid||v.randomBytes(16)}),address:o.address.toLowerCase().replace("0x",""),crypto:{ciphertext:l.toString("hex"),cipherparams:{iv:n.toString("hex")},cipher:t.cipher||"aes-128-ctr",kdf:f,kdfparams:s,mac:i.toString("hex")}}};function u(r){this._accounts=r,this.length=0,this.defaultKeyName="web3js_wallet"}u.prototype._findSafeIndex=function(r){return r=r||0,this.hasOwnProperty(r)?this._findSafeIndex(r+1):r};u.prototype._currentIndexes=function(){var r=Object.keys(this),e=r.map(function(t){return parseInt(t)}).filter(function(t){return t<9e20});return e};u.prototype.create=function(r,e){for(var t=0;t<r;++t)this.add(this._accounts.create(e).privateKey);return this};u.prototype.add=function(r){return typeof r=="string"&&(r=this._accounts.privateKeyToAccount(r)),this[r.address]?this[r.address]:(r=this._accounts.privateKeyToAccount(r.privateKey),r.index=this._findSafeIndex(),this[r.index]=r,this[r.address]=r,this[r.address.toLowerCase()]=r,this.length++,r)};u.prototype.remove=function(r){var e=this[r];return e&&e.address?(this[e.address].privateKey=null,delete this[e.address],this[e.address.toLowerCase()]&&(this[e.address.toLowerCase()].privateKey=null,delete this[e.address.toLowerCase()]),this[e.index].privateKey=null,delete this[e.index],this.length--,!0):!1};u.prototype.clear=function(){var r=this,e=this._currentIndexes();return e.forEach(function(t){r.remove(t)}),this};u.prototype.encrypt=function(r,e){var t=this,o=this._currentIndexes(),a=o.map(function(n){return t[n].encrypt(r,e)});return a};u.prototype.decrypt=function(r,e){var t=this;return r.forEach(function(o){var a=t._accounts.decrypt(o,e);if(a)t.add(a);else throw new Error("Couldn't decrypt accounts. Password wrong?")}),this};u.prototype.save=function(r,e){return localStorage.setItem(e||this.defaultKeyName,JSON.stringify(this.encrypt(r))),!0};u.prototype.load=function(r,e){var t=localStorage.getItem(e||this.defaultKeyName);if(t)try{t=JSON.parse(t)}catch(o){}return this.decrypt(t||[],r)};ce("localStorage")||(delete u.prototype.save,delete u.prototype.load);function ce(r){var e;try{e=self[r];var t="__storage_test__";return e.setItem(t,t),e.removeItem(t),!0}catch(o){return o&&(o.code===22||o.code===1014||o.name==="QuotaExceededError"||o.name==="NS_ERROR_DOM_QUOTA_REACHED")&&e&&e.length!==0}}var Pe=p;export{Pe as l};
