import{l}from"./web3-core-helpers.1fd5b4bd.js";import{o as u}from"./oboe.9a469b49.js";var h=l.errors,f=u.exports,e=function(n,s){var o=this;this.responseCallbacks={},this.notificationCallbacks=[],this.path=n,this.connected=!1,this.connection=s.connect({path:this.path}),this.addDefaultEvents();var c=function(i){var r=null;Array.isArray(i)?i.forEach(function(a){o.responseCallbacks[a.id]&&(r=a.id)}):r=i.id,!r&&i.method.indexOf("_subscription")!==-1?o.notificationCallbacks.forEach(function(a){typeof a=="function"&&a(i)}):o.responseCallbacks[r]&&(o.responseCallbacks[r](null,i),delete o.responseCallbacks[r])};s.constructor.name==="Socket"?f(this.connection).done(c):this.connection.on("data",function(i){o._parseResponse(i.toString()).forEach(c)})};e.prototype.addDefaultEvents=function(){var t=this;this.connection.on("connect",function(){t.connected=!0}),this.connection.on("close",function(){t.connected=!1}),this.connection.on("error",function(){t._timeout()}),this.connection.on("end",function(){t._timeout()}),this.connection.on("timeout",function(){t._timeout()})};e.prototype._parseResponse=function(t){var n=this,s=[],o=t.replace(/\}[\n\r]?\{/g,"}|--|{").replace(/\}\][\n\r]?\[\{/g,"}]|--|[{").replace(/\}[\n\r]?\[\{/g,"}|--|[{").replace(/\}\][\n\r]?\{/g,"}]|--|{").split("|--|");return o.forEach(function(c){n.lastChunk&&(c=n.lastChunk+c);var i=null;try{i=JSON.parse(c)}catch(r){n.lastChunk=c,clearTimeout(n.lastChunkTimeout),n.lastChunkTimeout=setTimeout(function(){throw n._timeout(),h.InvalidResponse(c)},1e3*15);return}clearTimeout(n.lastChunkTimeout),n.lastChunk=null,i&&s.push(i)}),s};e.prototype._addResponseCallback=function(t,n){var s=t.id||t[0].id,o=t.method||t[0].method;this.responseCallbacks[s]=n,this.responseCallbacks[s].method=o};e.prototype._timeout=function(){for(var t in this.responseCallbacks)this.responseCallbacks.hasOwnProperty(t)&&(this.responseCallbacks[t](h.InvalidConnection("on IPC")),delete this.responseCallbacks[t])};e.prototype.reconnect=function(){this.connection.connect({path:this.path})};e.prototype.send=function(t,n){this.connection.writable||this.connection.connect({path:this.path}),this.connection.write(JSON.stringify(t)),this._addResponseCallback(t,n)};e.prototype.on=function(t,n){if(typeof n!="function")throw new Error("The second parameter callback must be a function.");switch(t){case"data":this.notificationCallbacks.push(n);break;default:this.connection.on(t,n);break}};e.prototype.once=function(t,n){if(typeof n!="function")throw new Error("The second parameter callback must be a function.");this.connection.once(t,n)};e.prototype.removeListener=function(t,n){var s=this;switch(t){case"data":this.notificationCallbacks.forEach(function(o,c){o===n&&s.notificationCallbacks.splice(c,1)});break;default:this.connection.removeListener(t,n);break}};e.prototype.removeAllListeners=function(t){switch(t){case"data":this.notificationCallbacks=[];break;default:this.connection.removeAllListeners(t);break}};e.prototype.reset=function(){this._timeout(),this.notificationCallbacks=[],this.connection.removeAllListeners("error"),this.connection.removeAllListeners("end"),this.connection.removeAllListeners("timeout"),this.addDefaultEvents()};e.prototype.supportsSubscriptions=function(){return!0};var m=e;export{m as l};
