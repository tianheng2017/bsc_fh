import{e as v}from"./eventemitter3.3dc09485.js";import{f as p}from"./rollup-plugin-node-polyfills.dd1027b1.js";import{l as b}from"./web3-core-helpers.1fd5b4bd.js";import{b as E}from"./websocket.3b6e4b00.js";var O=Object.prototype.toString.call(typeof process!="undefined"?process:0)==="[object process]",C=typeof navigator!="undefined"&&navigator.product==="ReactNative",h=null,u=null;if(O||C){h=function(t){return Buffer.from(t).toString("base64")};var l=p;if(l.URL){var g=l.URL;u=function(t){return new g(t)}}else u=p.parse}else h=btoa.bind(typeof globalThis=="object"?globalThis:self),u=function(t){return new URL(t)};var y={parseURL:u,btoa:h},f=v.exports,a=y,r=b.errors,Q=E.w3cwebsocket,o=function(e,n){f.call(this),n=n||{},this.url=e,this._customTimeout=n.timeout||1e3*15,this.headers=n.headers||{},this.protocol=n.protocol||void 0,this.reconnectOptions=Object.assign({auto:!1,delay:5e3,maxAttempts:!1,onTimeout:!1},n.reconnect),this.clientConfig=n.clientConfig||void 0,this.requestOptions=n.requestOptions||void 0,this.DATA="data",this.CLOSE="close",this.ERROR="error",this.CONNECT="connect",this.RECONNECT="reconnect",this.connection=null,this.requestQueue=new Map,this.responseQueue=new Map,this.reconnectAttempts=0,this.reconnecting=!1;var s=a.parseURL(e);s.username&&s.password&&(this.headers.authorization="Basic "+a.btoa(s.username+":"+s.password)),s.auth&&(this.headers.authorization="Basic "+a.btoa(s.auth)),Object.defineProperty(this,"connected",{get:function(){return this.connection&&this.connection.readyState===this.connection.OPEN},enumerable:!0}),this.connect()};o.prototype=Object.create(f.prototype);o.prototype.constructor=o;o.prototype.connect=function(){this.connection=new Q(this.url,this.protocol,void 0,this.headers,this.requestOptions,this.clientConfig),this._addSocketListeners()};o.prototype._onMessage=function(t){var e=this;this._parseResponse(typeof t.data=="string"?t.data:"").forEach(function(n){if(n.method&&n.method.indexOf("_subscription")!==-1){e.emit(e.DATA,n);return}var s=n.id;Array.isArray(n)&&(s=n[0].id),e.responseQueue.has(s)&&(e.responseQueue.get(s).callback!==void 0&&e.responseQueue.get(s).callback(!1,n),e.responseQueue.delete(s))})};o.prototype._onConnect=function(){if(this.emit(this.CONNECT),this.reconnectAttempts=0,this.reconnecting=!1,this.requestQueue.size>0){var t=this;this.requestQueue.forEach(function(e,n){t.send(e.payload,e.callback),t.requestQueue.delete(n)})}};o.prototype._onClose=function(t){var e=this;if(this.reconnectOptions.auto&&(![1e3,1001].includes(t.code)||t.wasClean===!1)){this.reconnect();return}this.emit(this.CLOSE,t),this.requestQueue.size>0&&this.requestQueue.forEach(function(n,s){n.callback(r.ConnectionNotOpenError(t)),e.requestQueue.delete(s)}),this.responseQueue.size>0&&this.responseQueue.forEach(function(n,s){n.callback(r.InvalidConnection("on WS",t)),e.responseQueue.delete(s)}),this._removeSocketListeners(),this.removeAllListeners()};o.prototype._addSocketListeners=function(){this.connection.addEventListener("message",this._onMessage.bind(this)),this.connection.addEventListener("open",this._onConnect.bind(this)),this.connection.addEventListener("close",this._onClose.bind(this))};o.prototype._removeSocketListeners=function(){this.connection.removeEventListener("message",this._onMessage),this.connection.removeEventListener("open",this._onConnect),this.connection.removeEventListener("close",this._onClose)};o.prototype._parseResponse=function(t){var e=this,n=[],s=t.replace(/\}[\n\r]?\{/g,"}|--|{").replace(/\}\][\n\r]?\[\{/g,"}]|--|[{").replace(/\}[\n\r]?\[\{/g,"}|--|[{").replace(/\}\][\n\r]?\{/g,"}]|--|{").split("|--|");return s.forEach(function(i){e.lastChunk&&(i=e.lastChunk+i);var c=null;try{c=JSON.parse(i)}catch(k){e.lastChunk=i,clearTimeout(e.lastChunkTimeout),e.lastChunkTimeout=setTimeout(function(){if(e.reconnectOptions.auto&&e.reconnectOptions.onTimeout){e.reconnect();return}e.emit(e.ERROR,r.ConnectionTimeout(e._customTimeout)),e.requestQueue.size>0&&e.requestQueue.forEach(function(d,m){d.callback(r.ConnectionTimeout(e._customTimeout)),e.requestQueue.delete(m)})},e._customTimeout);return}clearTimeout(e.lastChunkTimeout),e.lastChunk=null,c&&n.push(c)}),n};o.prototype.send=function(t,e){var n=this,s=t.id,i={payload:t,callback:e};if(Array.isArray(t)&&(s=t[0].id),this.connection.readyState===this.connection.CONNECTING||this.reconnecting){this.requestQueue.set(s,i);return}if(this.connection.readyState!==this.connection.OPEN){this.requestQueue.delete(s),this.emit(this.ERROR,r.ConnectionNotOpenError()),i.callback(r.ConnectionNotOpenError());return}this.responseQueue.set(s,i),this.requestQueue.delete(s);try{this.connection.send(JSON.stringify(i.payload))}catch(c){i.callback(c),n.responseQueue.delete(s)}};o.prototype.reset=function(){this.responseQueue.clear(),this.requestQueue.clear(),this.removeAllListeners(),this._removeSocketListeners(),this._addSocketListeners()};o.prototype.disconnect=function(t,e){this._removeSocketListeners(),this.connection.close(t||1e3,e)};o.prototype.supportsSubscriptions=function(){return!0};o.prototype.reconnect=function(){var t=this;if(this.reconnecting=!0,this.responseQueue.size>0&&this.responseQueue.forEach(function(e,n){e.callback(r.PendingRequestsOnReconnectingError()),t.responseQueue.delete(n)}),!this.reconnectOptions.maxAttempts||this.reconnectAttempts<this.reconnectOptions.maxAttempts){setTimeout(function(){t.reconnectAttempts++,t._removeSocketListeners(),t.emit(t.RECONNECT,t.reconnectAttempts),t.connect()},this.reconnectOptions.delay);return}this.emit(this.ERROR,r.MaxAttemptsReachedOnReconnectingError()),this.reconnecting=!1,this.requestQueue.size>0&&this.requestQueue.forEach(function(e,n){e.callback(r.MaxAttemptsReachedOnReconnectingError()),t.requestQueue.delete(n)})};var q=o;export{q as l};
